<!DOCTYPE HTML>
<html>
<head>
    <title>io.anglur.smartDeck</title>
    <meta charset="utf-8"/>
</head>

<body>
<script>
    let websocket = null;
    let pluginUUID = null;
    let golangSocket = null;

    let numberdisplayAction = {
        type: "io.anglur.smartDeck.action",

        _send: function (dataToSend) {
            if (golangSocket.readyState === golangSocket.CLOSED) {
                golangSocket = new WebSocket("ws://localhost:1337");
                golangSocket.onopen = function () {
                    golangSocket.send(dataToSend);
                }
            } else {
                golangSocket.send(dataToSend);
            }
        },

        onKeyUp: function (coordinates) {
            this._send(JSON.stringify(coordinates));
        },

        onDeviceSleep: function () {
            this._send("DEVICE-SLEEPING");
        },

        onDeviceWake: function () {
            this._send("DEVICE-WAKE");
        }
    };

    function connectSocket(inPort, inPluginUUID, inRegisterEvent, inInfo) {
        pluginUUID = inPluginUUID;

        websocket = new WebSocket("ws://localhost:" + inPort);
        golangSocket = new WebSocket("ws://localhost:1337");

        function registerPlugin(inPluginUUID) {
            let json = {
                "event": inRegisterEvent,
                "uuid": inPluginUUID
            };

            websocket.send(JSON.stringify(json));
        }

        websocket.onopen = function () {
            registerPlugin(pluginUUID);
        };

        websocket.onmessage = function (evt) {
            let jsonObj = JSON.parse(evt.data);
            let event = jsonObj['event'];
            let jsonPayload = jsonObj['payload'] || {};

            if (event === "keyUp") {
                let coordinates = jsonPayload['coordinates'];
                numberdisplayAction.onKeyUp(coordinates);
            } else if (event === "deviceDidDisconnect") {
                numberdisplayAction.onDeviceSleep();
            } else if (event === "systemDidWakeUp") {
                numberdisplayAction.onDeviceWake();
            }
        };

        websocket.onclose = function () {
        };
    }
</script>
</body>

</html>